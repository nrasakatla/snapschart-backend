name: Issue ‚Üí Open PRs (multiple branches)

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  open_prs:
    runs-on: ubuntu-latest

    steps:
      - name: Gate ‚Äì run only for auto-merge label
        if: github.event.label.name != 'auto-merge'
        run: |
          echo "Not auto-merge label. Exiting."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body (branches + base)
        id: parse
        shell: bash
        run: |
          python3 - <<'PY'
          import json, re, os

          event = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
          body = event["issue"].get("body") or ""

          def grab(section):
              m = re.search(rf"### {re.escape(section)}\n(.*?)(\n### |\Z)", body, re.S)
              return (m.group(1).strip() if m else "")

          raw_branches = grab("Source branches (one per line)")
          base = grab("Target branch") or "master"

          branches = []
          for line in raw_branches.splitlines():
              line = line.strip().lstrip("-* ")
              if line:
                  branches.append(line)

          uniq = []
          for b in branches:
              if b not in uniq:
                  uniq.append(b)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"base={base}\n")
              f.write("branches<<EOF\n")
              f.write("\n".join(uniq) + "\n")
              f.write("EOF\n")
          PY

      - name: Create PRs for all branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e

          issue="${{ github.event.issue.number }}"
          base="${{ steps.parse.outputs.base }}"
          branches="${{ steps.parse.outputs.branches }}"

          result="### ‚úÖ Auto PR results\nTarget branch: \`$base\`\n\n"

          while IFS= read -r src; do
            [[ -z "$src" ]] && continue

            existing=$(gh pr list --head "$src" --base "$base" --state open | awk '{print $1}' | head -n 1 || true)
            if [[ -n "$existing" ]]; then
              gh pr edit "$existing" --add-label "automerge" >/dev/null 2>&1 || true
              result+="- üîÅ \`$src\`: PR already exists ‚Üí $existing\n"
              continue
            fi

            set +e
            out=$(gh pr create \
              --title "Auto PR: $src ‚Üí $base (issue #$issue)" \
              --body "Opened automatically from issue #$issue." \
              --base "$base" \
              --head "$src" \
              --label "automerge" 2>&1)
            code=$?
            set -e

            if [[ $code -eq 0 ]]; then
              url=$(echo "$out" | tail -n 1)
              result+="- ‚úÖ \`$src\`: PR created ‚Üí $url\n"
            else
              result+="- ‚ùå \`$src\`: $out\n"
            fi
          done <<< "$branches"

          gh issue comment "$issue" --body "$result"

      - name: Close issue after processing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close "${{ github.event.issue.number }}" \
            --comment "‚úÖ Automation completed. Closing issue."



