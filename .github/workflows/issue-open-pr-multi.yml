name: Issue ‚Üí Open PRs (multiple branches)

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  open_prs:
    if: >
      contains(github.event.issue.labels.*.name, 'auto-merge') &&
      startsWith(github.event.issue.title, '[auto-merge]')
    runs-on: ubuntu-latest

    steps:
      - name: Parse issue (branches + base)
        id: parse
        shell: bash
        run: |
          python3 - <<'PY'
          import json, re, os

          event = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
          body = event["issue"].get("body") or ""

          def grab(section):
            m = re.search(rf"### {re.escape(section)}\n(.*?)(\n### |\Z)", body, re.S)
            return (m.group(1).strip() if m else "")

          base = grab("Target branch") or "main"
          raw  = grab("Source branches (one per line)")

          # Split lines -> remove empty & bullet markers
          branches = []
          for line in raw.splitlines():
            line = line.strip()
            line = re.sub(r"^[\-\*\u2022]\s*", "", line)  # remove bullets
            if line:
              branches.append(line)

          # De-duplicate while preserving order
          seen=set()
          uniq=[]
          for b in branches:
            if b not in seen:
              uniq.append(b)
              seen.add(b)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
            f.write(f"base={base}\n")
            # write branches as newline-separated blob
            f.write("branches<<EOF\n")
            f.write("\n".join(uniq) + "\n")
            f.write("EOF\n")
          PY

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Create PRs for all branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          issue="${{ github.event.issue.number }}"
          base="${{ steps.parse.outputs.base }}"
          branches="${{ steps.parse.outputs.branches }}"

          if [[ -z "$branches" ]]; then
            gh issue comment "$issue" --body "‚ùå No source branches found in the issue."
            exit 1
          fi

          result_md="### ‚úÖ Auto PR results\nTarget branch: \`$base\`\n\n"

          while IFS= read -r src; do
            [[ -z "$src" ]] && continue

            # Guardrail: source != base
            if [[ "$src" == "$base" ]]; then
              result_md+="- ‚ö†Ô∏è \`$src\`: skipped (source == target)\n"
              continue
            fi

            # Optional guardrail: allow only specific prefixes (uncomment if you want)
            # if [[ ! "$src" =~ ^(feature/|bugfix/|hotfix/).+ ]]; then
            #   result_md+="- ‚ùå \`$src\`: blocked (branch name not allowed)\n"
            #   continue
            # fi

            # Branch existence check
            if ! gh api "repos/${{ github.repository }}/branches/$src" >/dev/null 2>&1; then
              result_md+="- ‚ùå \`$src\`: branch not found\n"
              continue
            fi

            # If an open PR already exists for head->base, reuse it
            existing_url=$(gh pr list --head "$src" --base "$base" --state open --json url -q '.[0].url' 2>/dev/null || true)
            if [[ -n "$existing_url" ]]; then
              # ensure labels exist (idempotent)
              gh pr edit "$existing_url" --add-label "automerge" --add-label "auto-merge" >/dev/null 2>&1 || true
              result_md+="- üîÅ \`$src\`: PR already exists ‚Üí $existing_url\n"
              continue
            fi

            # Create PR
            pr_url=$(gh pr create \
              --title "Auto PR: $src ‚Üí $base (issue #$issue)" \
              --body "Opened automatically from issue #$issue.\n\n‚è≥ Auto-merge will be attempted in 15 minutes if checks pass." \
              --base "$base" \
              --head "$src" \
              --label "automerge" \
              --label "auto-merge" \
              --json url -q .url 2>/dev/null || true)

            if [[ -n "$pr_url" ]]; then
              result_md+="- ‚úÖ \`$src\`: PR created ‚Üí $pr_url\n"
            else
              result_md+="- ‚ùå \`$src\`: failed to create PR (check workflow logs)\n"
            fi

          done <<< "$branches"

          # Comment results on issue
          gh issue comment "$issue" --body "$result_md"
