name: Issue ‚Üí Open PRs (multiple branches)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  open_prs:
    runs-on: ubuntu-latest

    steps:
      - name: Debug event + labels
        shell: bash
        run: |
          echo "event_name=${{ github.event_name }}"
          echo "action=${{ github.event.action }}"
          echo "issue_number=${{ github.event.issue.number }}"
          echo "issue_title=${{ github.event.issue.title }}"
          echo "labels_json=${{ toJson(github.event.issue.labels) }}"

      - name: Gate - require auto-merge label
        id: gate
        shell: bash
        run: |
          # Avoid join() quoting issues; use JSON string and contains()
          labels_json='${{ toJson(github.event.issue.labels.*.name) }}'
          echo "labels_json=$labels_json"

          python3 - <<'PY'
          import json, os, sys
          labels_json = os.environ.get("LABELS_JSON", "[]")
          labels = json.loads(labels_json) if labels_json else []
          ok = ("auto-merge" in labels) or ("automerge" in labels)
          print("proceed=" + ("true" if ok else "false"))
          PY
        env:
          LABELS_JSON: ${{ toJson(github.event.issue.labels.*.name) }}

      - name: Stop if label missing
        if: steps.gate.outputs.proceed != 'true'
        shell: bash
        run: |
          echo "Auto-merge label not present. Exiting."
          exit 0

      - name: Checkout repository
        uses: actions/checkout@v4
    

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Parse issue body (branches + base)
        id: parse
        shell: bash
        run: |
          python3 - <<'PY'
          import json, re, os

          event = json.load(open(os.environ["GITHUB_EVENT_PATH"]))
          body = event["issue"].get("body") or ""

          def grab(section):
              m = re.search(rf"### {re.escape(section)}\n(.*?)(\n### |\Z)", body, re.S)
              return (m.group(1).strip() if m else "")

          raw_branches = grab("Source branches (one per line)")
          base = grab("Target branch") or "master"

          branches = []
          for line in raw_branches.splitlines():
              line = line.strip()
              line = re.sub(r"^[\-\*\u2022]\s*", "", line)
              if line:
                  branches.append(line)

          seen=set()
          uniq=[]
          for b in branches:
              if b not in seen:
                  uniq.append(b)
                  seen.add(b)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"base={base}\n")
              f.write("branches<<EOF\n")
              f.write("\n".join(uniq) + "\n")
              f.write("EOF\n")
          PY

      - name: Create PRs for all branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          issue="${{ github.event.issue.number }}"
          base="${{ steps.parse.outputs.base }}"
          branches="${{ steps.parse.outputs.branches }}"

          if [[ -z "$branches" ]]; then
            gh issue comment "$issue" --body "‚ùå No branches found in issue under **Source branches (one per line)**."
            exit 1
          fi

          result="### ‚úÖ Auto PR results\nTarget branch: \`$base\`\n\n"

          # Ensure base exists
          if ! gh api "repos/${{ github.repository }}/branches/$base" >/dev/null 2>&1; then
            gh issue comment "$issue" --body "‚ùå Target branch not found: \`$base\`"
            exit 1
          fi

          while IFS= read -r src; do
            [[ -z "$src" ]] && continue

            if [[ "$src" == "$base" ]]; then
              result+="- ‚ö†Ô∏è \`$src\`: skipped (source == target)\n"
              continue
            fi

            if ! gh api "repos/${{ github.repository }}/branches/$src" >/dev/null 2>&1; then
              result+="- ‚ùå \`$src\`: branch not found\n"
              continue
            fi

            existing_url=$(gh pr list --head "$src" --base "$base" --state open --json url -q '.[0].url' 2>/dev/null || true)
            if [[ -n "$existing_url" ]]; then
              gh pr edit "$existing_url" --add-label "automerge" --add-label "auto-merge" >/dev/null 2>&1 || true
              result+="- üîÅ \`$src\`: PR already exists ‚Üí $existing_url\n"
              continue
            fi

            pr_url=$(gh pr create \
              --title "Auto PR: $src ‚Üí $base (issue #$issue)" \
              --body "Opened automatically from issue #$issue.\n\n‚è≥ Auto-merge will be attempted after the delay if checks pass." \
              --base "$base" \
              --head "$src" \
              --label "automerge" \
              --label "auto-merge" \
              --json url -q .url 2>/dev/null || true)

            if [[ -n "$pr_url" ]]; then
              result+="- ‚úÖ \`$src\`: PR created ‚Üí $pr_url\n"
            else
              result+="- ‚ùå \`$src\`: failed to create PR (see Actions logs)\n"
            fi
          done <<< "$branches"

          gh issue comment "$issue" --body "$result"
