name: Auto-merge PR after 15 minutes (no branch delete)

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write

jobs:
  automerge:
    # Run only when label "automerge" is added to the PR
    if: github.event.label.name == 'automerge'
    runs-on: ubuntu-latest

    steps:
      - name: Wait 15 minutes
        run: sleep 900

      - name: Merge PR if still mergeable (keep branch)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -e
          pr="${{ github.event.pull_request.number }}"
          repo="${{ github.repository }}"

          # Ensure PR is still open
          state=$(gh api "repos/$repo/pulls/$pr" --jq '.state')
          echo "PR state=$state"
          if [[ "$state" != "open" ]]; then
            echo "PR is not open anymore. Exiting."
            exit 0
          fi

          # mergeable can be null while GitHub is computing it
          mergeable=$(gh api "repos/$repo/pulls/$pr" --jq '.mergeable')
          echo "mergeable=$mergeable"
          if [[ "$mergeable" == "null" ]]; then
            echo "Mergeability not ready yet. Re-checking..."
            for i in 1 2 3 4 5; do
              sleep 10
              mergeable=$(gh api "repos/$repo/pulls/$pr" --jq '.mergeable')
              echo "mergeable=$mergeable"
              [[ "$mergeable" != "null" ]] && break
            done
          fi

          if [[ "$mergeable" != "true" ]]; then
            echo "PR is not mergeable (blocked/conflicts). Exiting."
            exit 0
          fi

          # Merge without deleting the source branch
          # Options: --squash (recommended), --merge, --rebase
          gh pr merge "$pr" --squash

