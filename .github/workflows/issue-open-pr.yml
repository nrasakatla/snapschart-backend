name: Issue → Open PR from branch

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  open_pr:
    if: >
      contains(github.event.issue.labels.*.name, 'auto-merge') &&
      startsWith(github.event.issue.title, '[auto-merge]')
    runs-on: ubuntu-latest

    steps:
      - name: Extract fields from issue body
        id: fields
        run: |
          body=$(jq -r .issue.body "$GITHUB_EVENT_PATH")

          # Extract Issue Forms values: they appear after headings like "### Source branch..."
          src=$(python3 - << 'PY'
import re, json, sys
event=json.load(open(sys.argv[1]))
body=event["issue"]["body"]
def grab(section):
    m=re.search(rf"### {re.escape(section)}\n(.*?)(\n### |\Z)", body, re.S)
    return (m.group(1).strip() if m else "")
print(grab("Source branch (must already exist)"))
PY
"$GITHUB_EVENT_PATH")

          base=$(python3 - << 'PY'
import re, json, sys
event=json.load(open(sys.argv[1]))
body=event["issue"]["body"]
def grab(section):
    m=re.search(rf"### {re.escape(section)}\n(.*?)(\n### |\Z)", body, re.S)
    return (m.group(1).strip() if m else "")
print(grab("Target branch"))
PY
"$GITHUB_EVENT_PATH")

          echo "src=$src" >> "$GITHUB_OUTPUT"
          echo "base=$base" >> "$GITHUB_OUTPUT"

      - name: Validate branch exists and is allowed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          src="${{ steps.fields.outputs.src }}"
          base="${{ steps.fields.outputs.base }}"

          if [[ -z "$src" || -z "$base" ]]; then
            echo "Missing source/base branch" && exit 1
          fi

          # ✅ Guardrail: disallow dangerous sources
          if [[ "$src" == "$base" ]]; then
            echo "Source and base branch are same. Nothing to do." && exit 1
          fi

          # ✅ Optional guardrail: only allow feature/* or bugfix/* etc
          # Uncomment if you want:
          # if [[ ! "$src" =~ ^(feature/|bugfix/|hotfix/).+ ]]; then
          #   echo "Branch not allowed: $src" && exit 1
          # fi

          # Check branch exists in remote
          if ! gh api "repos/${{ github.repository }}/branches/$src" >/dev/null 2>&1; then
            echo "Branch does not exist: $src" && exit 1
          fi

          # Check base exists too
          if ! gh api "repos/${{ github.repository }}/branches/$base" >/dev/null 2>&1; then
            echo "Base branch does not exist: $base" && exit 1
          fi

      - name: Create PR (or find existing)
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          src="${{ steps.fields.outputs.src }}"
          base="${{ steps.fields.outputs.base }}"
          issue="${{ github.event.issue.number }}"

          # If PR already exists for src->base, reuse it
          existing=$(gh pr list --head "$src" --base "$base" --state open --json number,url -q '.[0].url' || true)
          if [[ -n "$existing" ]]; then
            echo "pr_url=$existing" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pr_url=$(gh pr create \
            --title "Auto PR: $src → $base (issue #$issue)" \
            --body "Opened automatically from issue #$issue.\n\n⏳ Auto-merge will be attempted in 15 minutes if checks pass." \
            --base "$base" \
            --head "$src" \
            --label automerge \
            --label auto-merge \
            --json url -q .url)

          echo "pr_url=$pr_url" >> "$GITHUB_OUTPUT"

      - name: Comment on issue with PR link
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "✅ PR ready: ${{ steps.pr.outputs.pr_url }}\n\n⏳ Will attempt auto-merge in 15 minutes (checks must pass)."
